name: build powermem-server docker

on: 
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, develop]

jobs:
  build-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine if should push
        id: should-push
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]]; then
            echo "should_push=true" >> $GITHUB_OUTPUT
          else
            echo "should_push=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker hub (for tag push only)
        if: steps.should-push.outputs.should-push == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image (for tags)
        if: steps.should-push.outputs.should-push == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          file: docker/Dockerfile
          push: true
          tags: |
            ${{ vars.DOCKER_PUSH_BASE }}/powermem-server:latest
            ${{ vars.DOCKER_PUSH_BASE }}/powermem-server:${{ github.ref_name }}

      - name: Build and save Docker images (for PR and branches)
        if: steps.should-push.outputs.should-push == 'false'
        run: |
          mkdir -p docker-images
          
          IMAGE_NAME="powermem-server"
          IMAGE_TAG="${{ github.ref_name }}"
          
          # Build and save for each platform
          for platform in linux/amd64 linux/arm64; do
            platform_suffix=$(echo $platform | tr '/' '-')
            image_tag="${IMAGE_NAME}:${platform_suffix}"
            output_file="docker-images/${IMAGE_NAME}-${platform_suffix}.tar"
            
            echo "Building image for platform: $platform"
            
            # Build the image for the specific platform and load it
            docker buildx build \
              --context . \
              --file docker/Dockerfile \
              --platform $platform \
              --load \
              --tag ${image_tag}
            
            # Save the image as tar file
            echo "Saving image to: ${output_file}"
            docker save ${image_tag} -o ${output_file}
            
            # Verify the file was created
            if [ -f "${output_file}" ]; then
              echo "✓ Successfully saved: ${output_file} ($(du -h ${output_file} | cut -f1))"
            else
              echo "✗ Failed to save: ${output_file}"
              exit 1
            fi
          done
          
          # List all saved files
          echo ""
          echo "All saved Docker images:"
          ls -lh docker-images/
          echo ""
          echo "To load these images, use: docker load -i <tar-file>"

      - name: Upload Docker image artifacts (for PR and branches)
        if: steps.should-push.outputs.should-push == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: powermem-server-docker-images
          path: docker-images/*.tar
          retention-days: 30
          if-no-files-found: error
